<!-- world-view.component.html -->

<!-- FIX: Vuelve el preloader inicial para "Obteniendo datos..." -->
<div *ngIf="isLoadingData" class="preloader-overlay">
  <div class="preloader-content">
    <h1>Obteniendo datos del episodio...</h1>
  </div>
</div>

<app-add-object-modal *ngIf="isAddObjectModalVisible" (close)="closeAddObjectModal()"
  (create)="createSceneObject($event)">
</app-add-object-modal>

<!-- FIX: La condici√≥n !isLoadingData es clave aqu√≠. El div no se crea hasta que los datos b√°sicos existen. -->
<div *ngIf="!isLoadingData && !errorMessage && episodeId" 
     class="editor-layout"
     [class.left-hidden]="!layoutState.leftVisible"
     [class.right-hidden]="!layoutState.rightVisible"
     [class.bottom-hidden]="!layoutState.bottomVisible">

  <header class="editor-top-bar">
    <div class="episode-title">
      Editor - {{ episodeTitle }}
    </div>
  </header>
  
  <aside class="left-sidebar">
    <!-- El contenido de la barra izquierda no ha cambiado -->
    <div class="panel scene-list-panel">
      <div class="panel-header">Lista de Objetos</div>
      <div class="search-bar-container">
        <input type="text" class="search-input" placeholder="ÔÄÇ Buscar por nombre..." [ngModel]="searchFilter"
          (ngModelChange)="onSearchChange($event)" aria-label="Buscar objeto en la escena">
      </div>
      <div #sceneListContent class="panel-content scrollable" cdkDropListGroup>
        <ng-container *ngIf="displayGroups$ | async as groups">
          <div *ngIf="groups.length > 0; else noResults">
            <div *ngFor="let group of groups; trackBy: trackByGroupType" class="object-group">
              <div class="group-header" (click)="toggleGroup(group)" [class.group-hidden]="!group.isGroupVisible">
                <span class="group-toggle-icon">{{ group.isExpanded ? '‚ñº' : '‚ñ∂' }}</span>
                <span class="group-name">{{ group.type }}</span>
                <span class="group-count">({{ group.totalCount }})</span>
                <button class="group-visibility-toggle" (click)="toggleGroupVisibility(group, $event)"
                  [title]="group.isGroupVisible ? 'Ocultar grupo' : 'Mostrar grupo'">
                  <span *ngIf="group.isGroupVisible" class="icon-eye-open"></span>
                  <span *ngIf="!group.isGroupVisible" class="icon-eye-closed"></span>
                </button>
              </div>
              <ng-container *ngIf="group.isExpanded">
                <div class="group-controls">
                  <span class="brightness-icon" title="Brillo / Opacidad del Grupo"></span>
                  <input type="range" class="brightness-slider" min="0" max="1" step="0.01" [value]="group.brightness"
                    (input)="onGroupBrightnessChange(group, $event)" (click)="$event.stopPropagation()"
                    title="Brillo / Opacidad: {{ group.brightness * 100 | number:'1.0-0' }}%">
                </div>
                <ul class="scene-object-list" cdkDropList [cdkDropListData]="group.visibleEntities"
                  (cdkDropListDropped)="onDrop($event)">
                  <li *ngFor="let e of group.visibleEntities; trackBy: trackByEntity" cdkDrag class="scene-object-item"
                    [class.selected]="e.uuid === selectedEntityUuid" [ngClass]="getColorClassForEntity(e)"
                    (click)="onEntitySelect(e)">
                    <span class="object-icon">{{ e.type === 'Camera' ? 'üì∑' : e.type==='Light'?'üí°': (e.type === 'Model'
                      ? 'üì¶' : '‚óè') }}</span>
                    <span class="object-name">{{ e.name }}</span>
                  </li>
                </ul>
                <div class="list-loader" *ngIf="group.visibleEntities.length < group.totalCount">
                  <button (click)="showMoreInGroup(group)" class="show-more-button">
                    Cargar M√°s ({{ group.visibleEntities.length }} / {{ group.totalCount }})
                  </button>
                </div>
              </ng-container>
            </div>
          </div>
          <ng-template #noResults>
            <div *ngIf="totalFilteredEntityCount === 0 && searchFilter" class="empty-state">
              No se encontraron objetos con ese nombre.
            </div>
            <div *ngIf="!searchFilter && allEntities.length === 0" class="empty-state">
              La escena est√° vac√≠a.
            </div>
          </ng-template>
        </ng-container>
        <ul class="scene-object-list" *ngIf="!searchFilter">
          <li *ngFor="let e of placeholderEntities" class="scene-object-item placeholder-item"
            (click)="onEntitySelect(e)">
            {{ e.name }}
          </li>
        </ul>
      </div>
    </div>
  </aside>
  
  <main class="main-viewport">
    <div class="scene-container-header">
      <div class="scene-tabs-container">
        <button 
          *ngFor="let scene of sceneTabs" 
          class="scene-tab-button" 
          [class.active]="scene.isActive"
          (click)="selectScene(scene.id)">
            <span>{{ scene.name }}</span>
        </button>
        <button class="scene-tab-button add-scene" (click)="addScene()" title="A√±adir nueva escena">+</button>
      </div>
      <app-toolbar 
        [isMaximized]="layoutState.isMaximized" 
        (maximizeToggle)="onMaximizeToggle()">
      </app-toolbar>
    </div>
    <div class="scene-render-area">

      <!-- Loader espec√≠fico para el √°rea de la escena, solo se muestra si est√° renderizando -->
      <div *ngIf="isRenderingScene" class="scene-loader-overlay">
        <div class="preloader-content">
          <h1>Cargando Escena...</h1>
          <div class="progress-bar-container">
            <div class="progress-bar" [style.width.%]="loadingProgress"></div>
          </div>
          <p class="progress-text">{{ loadingProgress | number:'1.0-0' }}%</p>
        </div>
      </div>
      
      <div *ngIf="(axisLock$ | async) as lockedAxis" class="axis-lock-indicator" [ngClass]="'lock-' + lockedAxis">
        Moviendo en Eje: <b>{{ lockedAxis | uppercase }}</b>
      </div>
      <div class="camera-position-display" *ngIf="engineService.cameraPosition$ | async as pos">
        <b>Posici√≥n C√°mara:</b><br>
        X: {{ pos.x | number:'1.2-2' }}<br>
        Y: {{ pos.y | number:'1.2-2' }}<br>
        Z: {{ pos.z | number:'1.2-2' }}
      </div>
      <div *ngIf="isFlyModeActive$ | async" class="fly-mode-crosshair">
        <div class="crosshair-line horizontal"></div>
        <div class="crosshair-line vertical"></div>
      </div>
      
      <!-- Se oculta la escena mientras se carga con [style.visibility] para que mantenga su espacio -->
      <app-scene 
        [initialObjects]="sceneObjects" 
        (loadingProgress)="handleLoadingProgress($event)"
        (loadingComplete)="handleLoadingComplete()"
        [style.visibility]="isRenderingScene ? 'hidden' : 'visible'">
      </app-scene>
      
      <app-brujula></app-brujula>
    </div>
  </main>
  
  <aside class="right-sidebar">
    <!-- El contenido de la barra derecha no ha cambiado -->
    <div class="right-sidebar-top-group">
      <div class="panel episode-image-panel">
        <div class="panel-header">Imagen del Episodio</div>
        <div class="panel-content">
          <div class="placeholder-panel">
            <p>Componente de imagen.</p>
          </div>
        </div>
      </div>
      <div class="panel episode-objects-panel">
        <div class="panel-header">Objetos del Episodio</div>
        <div class="panel-content">
          <div class="placeholder-panel">
            <p>Lista de objetos/assets disponibles.</p>
          </div>
        </div>
      </div>
    </div>
    <div class="panel fps-panel">
      <div class="panel-header">Rendimiento</div>
      <div class="panel-content">
        <div class="placeholder-panel">
          <p>Stats (FPS, Mem, etc).</p>
        </div>
      </div>
    </div>
  </aside>
  
  <footer class="bottom-properties">
    <!-- El contenido de los paneles inferiores no ha cambiado -->
    <div class="bottom-tabs-header">
      <button class="bottom-tab-button" [class.active]="activePropertiesTab==='object'"
        (click)="selectPropertiesTab('object')" [disabled]="!selectedObject">Transformaci√≥n</button>
      <button class="bottom-tab-button" [class.active]="activePropertiesTab==='scene'"
        (click)="selectPropertiesTab('scene')">Render</button>
      <button class="bottom-tab-button" [class.active]="activePropertiesTab==='world'"
        (click)="selectPropertiesTab('world')">Ajustes</button>
    </div>
    <div class="bottom-tabs-content">
      <ng-container [ngSwitch]="activePropertiesTab">
        <ng-container *ngSwitchCase="'object'">
          <app-properties-panel [selectedObject]="selectedObject" (objectUpdate)="handleObjectUpdate($event)">
          </app-properties-panel>
          <div *ngIf="!selectedObject" class="placeholder-panel">
            <h2>Propiedades del Objeto</h2>
            <p>Selecciona un objeto para ver sus transformaciones y propiedades.</p>
          </div>
        </ng-container>
        <ng-container *ngSwitchCase="'scene'">
          <app-scene-settings-panel></app-scene-settings-panel>
        </ng-container>
        <div *ngSwitchDefault class="placeholder-panel">
          <h2>{{ activePropertiesTab | titlecase }}</h2>
          <p>Contenido de la pesta√±a {{ activePropertiesTab }}.</p>
        </div>
      </ng-container>
    </div>
  </footer>
  
  <div class="bottom-description">
    <!-- El contenido del panel de descripci√≥n no ha cambiado -->
    <div class="panel">
      <div class="panel-header">Descripci√≥n del Objeto</div>
      <div class="panel-content">
        <div *ngIf="selectedObject; else noObjectSelectedForDescription" class="description-editor">
          <textarea placeholder="A√±ade una descripci√≥n para {{selectedObject.name}}..."></textarea>
        </div>
        <ng-template #noObjectSelectedForDescription>
          <div class="placeholder-panel">
            <p>Selecciona un objeto para ver o editar su descripci√≥n.</p>
          </div>
        </ng-template>
      </div>
    </div>
  </div>
  
  <button class="panel-toggle-tab left" *ngIf="!layoutState.leftVisible" (click)="togglePanelVisibility('left')" title="Mostrar panel izquierdo">
    <span>&#9654;</span>
  </button>
  <button class="panel-toggle-tab right" *ngIf="!layoutState.rightVisible" (click)="togglePanelVisibility('right')" title="Mostrar panel derecho">
    <span>&#9664;</span>
  </button>
  <button class="panel-toggle-tab bottom" *ngIf="!layoutState.bottomVisible" (click)="togglePanelVisibility('bottom')" title="Mostrar paneles inferiores">
    <span>&#9650;</span>
  </button>
</div>

<div *ngIf="errorMessage" class="error-state">{{ errorMessage }}</div>