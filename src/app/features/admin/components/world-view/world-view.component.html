<!-- Carga API -->
<div *ngIf="isLoadingData" class="preloader-overlay">
  <div class="preloader-content">
    <h1>Obteniendo datos del episodio...</h1>
  </div>
</div>

<!-- Carga escena -->
<div *ngIf="!isLoadingData && isRenderingScene" class="preloader-overlay">
  <div class="preloader-content">
    <h1>Cargando Escena...</h1>
    <div class="progress-bar-container">
      <div class="progress-bar" [style.width.%]="loadingProgress"></div>
    </div>
    <p class="progress-text">{{ loadingProgress | number:'1.0-0' }}%</p>
  </div>
</div>

<!-- Modal nuevo objeto -->
<app-add-object-modal *ngIf="isAddObjectModalVisible"
  (close)="closeAddObjectModal()"
  (create)="createSceneObject($event)">
</app-add-object-modal>

<!-- Editor -->
<div *ngIf="!isLoadingData && !errorMessage && episodeId" class="editor-layout"
     [style.visibility]="isRenderingScene ? 'hidden' : 'visible'">

  <header class="editor-header">
    <span>Editor - {{ episodeTitle }}</span>
  </header>

  <main class="viewport">
    <app-toolbar></app-toolbar>
    <div *ngIf="(axisLock$ | async) as lockedAxis" class="axis-lock-indicator" [ngClass]="'lock-' + lockedAxis">
      Moviendo en Eje: <b>{{ lockedAxis | uppercase }}</b>
    </div>
    <app-scene
      [initialObjects]="sceneObjects"
      (loadingProgress)="handleLoadingProgress($event)"
      (loadingComplete)="handleLoadingComplete()">
    </app-scene>
    <app-brujula></app-brujula>
  </main>

  <aside class="sidebar" [class.visible-mobile]="isMobileSidebarVisible">
    <!-- Lista Objetos -->
    <div class="panel scene-list-panel">
      <div class="panel-header">Elementos en la Escena</div>
      <div class="panel-content">
        
        <!-- 🎯 CORRECCIÓN: Usamos *ngIf para garantizar que los datos no sean nulos -->
        <ng-container *ngIf="realEntities$ | async as realEntities">
          <ul class="scene-object-list"
              cdkDropList
              [cdkDropListData]="realEntities" 
              (cdkDropListDropped)="onDrop($event)">

            <!-- Bucle para los OBJETOS REALES (arrastrables) -->
            <li *ngFor="let e of realEntities"
                cdkDrag
                class="scene-object-item"
                [class.selected]="e.uuid === selectedEntityUuid"
                [ngClass]="getColorClassForEntity(e)"
                (click)="onEntitySelect(e)">
              
              <span class="object-icon">{{ e.type === 'Camera' ? '📷' : e.type==='Light'?'💡':'📦' }}</span>
              <span class="object-name">{{ e.name }}</span>
            </li>
          </ul>
        </ng-container>

        <!-- La lista de placeholders se renderiza por separado y no es parte del drag-drop -->
        <ul class="scene-object-list">
          <li *ngFor="let e of placeholderEntities"
              class="scene-object-item placeholder-item"
              (click)="onEntitySelect(e)">
            {{ e.name }}
          </li>
        </ul>

        <!-- Mensaje de estado vacío -->
        <div *ngIf="!(realEntities$ | async)?.length" class="empty-state">
          La escena está vacía.
        </div>
      </div>
    </div>

    <!-- Propiedades -->
    <div class="properties-container">
      <div class="properties-tabs">
        <button class="tab-button" title="Render" [class.active]="activePropertiesTab==='render'" (click)="selectPropertiesTab('render')">📷</button>
        <button class="tab-button" title="Output" [class.active]="activePropertiesTab==='output'" (click)="selectPropertiesTab('output')">🖨️</button>
        <button class="tab-button" title="ViewLayer" [class.active]="activePropertiesTab==='view-layer'" (click)="selectPropertiesTab('view-layer')">🖼️</button>
        <button class="tab-button" title="Scene" [class.active]="activePropertiesTab==='scene'" (click)="selectPropertiesTab('scene')">🏞️</button>
        <button class="tab-button" title="World" [class.active]="activePropertiesTab==='world'" (click)="selectPropertiesTab('world')">🌍</button>
        <ng-container *ngIf="selectedObject">
          <div class="tabs-separator"></div>
          <button class="tab-button" title="Object" [class.active]="activePropertiesTab==='object'" (click)="selectPropertiesTab('object')">🧊</button>
          <button class="tab-button" title="Modifiers" [class.active]="activePropertiesTab==='modifiers'" (click)="selectPropertiesTab('modifiers')">🔧</button>
          <button class="tab-button" title="Constraints" [class.active]="activePropertiesTab==='constraints'" (click)="selectPropertiesTab('constraints')">🔗</button>
          <button class="tab-button" title="Data" [class.active]="activePropertiesTab==='data'" (click)="selectPropertiesTab('data')">🟢</button>
          <button class="tab-button" title="Material" [class.active]="activePropertiesTab==='material'" (click)="selectPropertiesTab('material')">🌐</button>
        </ng-container>
      </div>
      <div class="properties-content">
        <ng-container [ngSwitch]="activePropertiesTab">
          <ng-container *ngSwitchCase="'object'">
            <app-properties-panel
              [selectedObject]="selectedObject"
              (objectUpdate)="handleObjectUpdate($event)">
            </app-properties-panel>
          </ng-container>
          <div *ngSwitchCase="'render'" class="placeholder-panel">
            <h2>Propiedades de Render</h2><p>(Próximamente)</p>
          </div>
          <ng-container *ngSwitchCase="'scene'">
            <app-scene-settings-panel></app-scene-settings-panel>
          </ng-container>
          <div *ngSwitchDefault class="placeholder-panel">
            <h2>{{ activePropertiesTab | titlecase }}</h2>
            <p>Selecciona una pestaña para ver sus propiedades.</p>
            <p>(Próximamente)</p>
          </div>
        </ng-container>
      </div>
    </div>
  </aside>

  <button class="mobile-sidebar-toggle" (click)="toggleMobileSidebar()" title="Mostrar/Ocultar Paneles">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
      <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
    </svg>
  </button>
  
</div>

<div *ngIf="errorMessage" class="error-state">{{ errorMessage }}</div>